{"name":"Commercial Detection","tagline":"Google Summer of Code 2015, Red Hen Labs","body":"# Building an automated commercial detection system\r\n\r\nThink about this situation, you are watching a really enthralling movie that you have recorded on your TV. You are engrossed into the movie and as it proceeds, the stage is set for the plot to unfold, you are on your toes, eagerly waiting to see how it culminates and snap! its a commercial break!. I am sure all of you have been in this situation, if you haven't, let me tell you, its one of the most annoying things about television. But wait, what if we could eliminate this problem completely ? What if there was a system that could completely remove all the ads you hate for you?   \r\n \r\nThis is precisely the system that Red Hen Labs plans on having, an automated and robust commercial detection system, one that is generic for all TV, regardless of the language or the genre of the TV show. I am really grateful that I have been given an opportunity to build such a system under the guidance of Carlos Fern√°ndez Sanz and Weixin Li as a part of Google Summer of Code, 2015.  \r\n\r\nThis blog is meant as a general report of progress for my project, but I plan on making it a tutorial to both easily use this system and to develop your own from scratch. If you ever wanted to do some fun singal processing, image processing and machine learning all at the same time, this would be a great project to get your hands on.  \r\n\r\n# Using the system\r\nCurrently, the instructions are for Debian based Linux systems. \r\nInstall the dependencies by running the script dependencies.sh and download the MySQL db. Then run this: \r\n\r\n    python main.py <path-to-tv-recording>\r\n\r\nThis will create a file called output.txt, that contains the location of all the commercials. The output will be like this: \r\n\r\n    00:00:00 - 00:09:38 = TV\r\n    00:09:38 - 00:09:52 = Commercial by Pepsi\r\n    00:09:52 - 00:10:05 = Commercial by Nike\r\n    ....\r\n    .\r\nDo you just enjoy watching Nike ads ? Great, then just delete these lines from output.txt, you do not want any ads ? Then just keep the file as is. In the end run the following code:\r\n### This part is still under development\r\n    python remove_ads.py <output.txt> <path-to-tv-recording> <new-name-of-video>\r\nThis is it, you have your recorded TV, with only your favorite commercials in them, you can go watch your TV show then.\r\n\r\n#Building one from scratch\r\nThis part of the blog will be edited, until the end of the project, so if you are seeing it, any time before September 2015, know that, its not the final version of the blog.\r\n\r\n##How humans detect commercials\r\n \r\nThe most naive way of building any automated system would be to first think of how a human does it, then try mimicking that. So, how do you differentiate between a commercial and TV? Its amazing how, once you start to think this way, even the most trivial tasks such as this one, appear so convoluted. Its seemingly too easy for us as humans to detect commercials under normal situations, but its a really hard thing for a computer to do, so to even out the scales a little, lets put a human in a different situation, one where this task won't appear quite so trivial and then mimic the path the human took to learn, under such a situation. \r\n\r\nLet us think of this hypothetical situation, imagine all your memory about TV shows, movies, advertisements, everything was magically wiped out. Now you switch on the TV, you tune in to a channel which has a language you don't know. So you are basically destitute of any means of recognizing commercials based on previous memory or by understanding the language. The TV is turned on right in the middle of an ongoing TV show / ad, so you don't have any clue about which part you are in. You continue watching and you realize in a really short time, whether you are in a middle of a TV or an ad. You form this conclusion, based on how the scenes changed, on how people talk, from the tone of the background music and other such things, you just know its TV or ad, even though you have a hard time explaining to people about how you figured that out (this is the convoluted part I was talking about).  \r\n\r\nNow you can differentiate between that particular TV show and ads, and you watched TV for less than 10 minutes, staggering progress! Our task is not yet done though, you have to detect the ads, that is, see what they are trying to advertise. Remember, you can't read anything on the screen, because you don't know the language. So just how do you know what product they are advertising then ? Its not possible, so you need the help of a person who knows the language here, or someone who can identify the company logo for you, then you enter a report telling when the ad occurred and what it was advertising. This is how you learned to detect commercials. With time, you will learn these logos yourself or may be even the pattern of text in the language and be able to detect new commercials of the same company, provided they don't change their logo. One of the good things is, once you have seen a commercial and you remember it, you can detect its occurrence quickly in just a matter of seconds. Hence, even being placed under this hypothetical situation, your brain has become a commercial detector. Now that you have a glimpse of how the human brain does it, lets proceed to the more exciting part of mimicking it.  \r\n\r\n## Mimicking the human brain\r\n\r\nThe only resource at my disposal was access to HD videos of TV recordings, my task was to build a commercial detection system from this. My first thought was, a human divides the video in to blocks, based on how different the blocks are and then designates whether that block was a commercial or not. Even though this exact process of how the mind divides it into blocks and later classifies them was rather obscure, I went ahead to implement it. After spending a lot of hours and coming up with a not so robust system to do this, I discussed it with Carlos, who made me realize that I should be looking at teaching the system(building a supervised learning algorithm) rather making it completely learn by itself.\r\n\r\nNow I had to teach the computer, to differentiate between a commercial and TV and also detect the commercial if possible, how could I teach something I don't know myself? So, I went through one of the recorded videos and made a report, this report looked like the output file that should be generated by the system. This is what is called my training data. Using ffmpeg, these regions of commercials were copied out from the video and stored separately in a folder. A csv file was made, which contained the path to these hand picked commercials and the name and duration of each of them. It also had a field verified(will come to this later), the csv file just acted as a user friendly database.\r\n\r\nLet us come back to the brain analogy, if the brain under that hypothetical situation I described earlier had seen these commercials, we know that it would surely identify any occurrence of the same in any video, in seconds. This was the first thing I had to teach the computer to do, a 100% recognition of seen commercials. The words 100% and recognition when put together are really intimidating for any one with some background in machine learning. But if you look more closely, every commercial has some audio, we had to find a method to find a 100% match of the same signal in other videos. Mattia Cerrato, a student developer at the time, at Red Hen Labs, suggested that audio fingerprinting would be just the thing to achieve this.\r\n\r\nIf you want to read more about audio fingerprinting, you should really visit [Will Drevo's blog](http://willdrevo.com/fingerprinting-and-audio-recognition-with-python/) , its one of the best explanation on the topic I could find on the web. He explains the working of his open source project Dejavu, which does audio fingerprinting, in it. I integrated Dejavu as a part of the system, so now I could achieve an accuracy of 100% detection of already seen commercials. \r\n\r\n### Implementing audio fingerprinting using Dejavu\r\nWe obtain the audio of the entire video using ffmpeg.\r\nThe pseudo code for the matching process is follows:  \r\n\r\n    //Initially, building the fingerprint database\r\n    for item in database:\r\n         //build fingerprint for item and store this fingerprint in a Mysql db(done by Dejavu)\r\n\r\n    //Recognizing commercials in the given video\r\n    start = 0\r\n    end = end time of video\r\n    audio = audio of the video\r\n    fingerprint_length = 5 seconds // 5 seconds was apt to get really good fingerprints, more stats are in Dejavu docs\r\n    skip_length = (Duration of the shortest commercial in db) - (fingerprint_length) \r\n    while start < end:\r\n           //Obtain start to start + 5 seconds of audio and fingerprint it\r\n           if there is a match for the fingerprint:\r\n                 //Obtain the offset of the fingerprint, done by Dejavu\r\n                 com_start = start - offset\r\n                 com_end = start + duration // duration obtained from the handpicked database\r\n                 //Write com_start and com_end into the output file, along with name of the commercial\r\n                 start = start - offset + duration // Skip directly to end of detected commercial and continue scanning\r\n           else: \r\n                 start = start + skip_length\r\n\r\nThus, after doing these steps, we obtain a system that can recognize seen commercials like a human. But this means we have to teach it every commercial on the planet to make it robust, and keep teaching it too, this is not feasible by any means, so we will proceed to make it automated.\r\n\r\n## Automating the process\r\n![Work under progress](http://www.fictionlab-fctp.it/wp-content/uploads/2015/02/workInProgress-487x435.jpg)\r\n\r\n#References\r\n*Real time commercial detection using MPEG features - http://www.researchgate.net/profile/Nevenka_Dimitrova/publication/229024227_Real_time_commercial_detection_using_MPEG_features/links/00b7d52b9b0879c1bc000000.pdf\r\n\r\n*Automatic detection of TV commercials - http://www.researchgate.net/profile/Oge_Marques/publication/3227702_Automatic_detection_of_TV_commercials/links/0c96051e533d12d515000000.pdf\r\n\r\n*A high-performance shot boundary detection algorithm using multiple cues\r\n\r\n*Story Segmentation and Detection of Commercials\r\nIn Broadcast News Video - http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.46.6845&rep=rep1&type=pdf\r\n\r\n*CONSTRUCTION AND EVALUATION OF A ROBUST MULTIFEATURE SPEECH/MUSIC\r\nDISCRIMINATOR - http://www.ee.columbia.edu/~dpwe/papers/ScheiS97-mussp.pdf\r\n\r\n*On the detection and recognition of television commercials - https://ub-madoc.bib.uni-mannheim.de/800/1/TR-96-016.pdf\r\n\r\n*Time constraint boost for TV commercial detection - http://research.microsoft.com/en-us/um/people/taoqin/papers/qin-icip04.pdf\r\n\r\n*A confidence based recognition system for TV commercials - http://crpit.com/confpapers/CRPITV75Li.pdf\r\n\r\n*Comparision and combination of two novel Commercial detection methods - http://www.cs.cmu.edu/~mychen/publication/duygulu_ICME04.pdf\r\n\r\n*A psuedo statistical approach to commercial detection - http://lyle.smu.edu/~prangara/Report_Commercial_Boundary_Detection.pdf\r\n\r\n*Real time commercial detection in video - http://www.cse.msu.edu/~fengzhey/downloads/projects/before2015/Comcast-2013.pdf\r\n\r\n*Detection of commercials using sift - http://www.ijetae.com/files/Volume4Issue6/IJETAE_0614_82.pdf\r\n\r\n*Robust learning based TV commercial detection - http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.72.9758&rep=rep1&type=pdf         ","google":"UA-62716746-1","note":"Don't delete this file! It's used internally to help with page regeneration."}